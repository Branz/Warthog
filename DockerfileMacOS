# syntax=docker/dockerfile:1

ARG OSXCROSS_VERSION=latest
FROM --platform=$BUILDPLATFORM crazymax/osxcross:${OSXCROSS_VERSION}-alpine AS osxcross

FROM alpine as build
RUN apk add --no-cache clang lld musl-dev
ENV PATH="/osxcross/bin:$PATH"
ENV LD_LIBRARY_PATH="/osxcross/lib:$LD_LIBRARY_PATH"
COPY --from=osxcross /osxcross /osxcross
RUN apk add meson libgcc musl-dev gcc g++ upx
COPY . /code
RUN mkdir /build
WORKDIR /code
RUN meson setup --cross-file aarch64.txt build-osx
RUN meson compile -C build-osx -v
RUN mkdir /install
RUN DESTDIR=/install meson install -C build-osx

FROM scratch AS export-stage
COPY --from=build install/usr/local/bin/wart-node .
COPY --from=build install/usr/local/bin/wart-wallet .
